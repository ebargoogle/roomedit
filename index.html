<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>

<h1>Room Editor</h1>

<style>
table{
  border-collapse: collapse;
}

table, th, td{
  border: 0px solid black;
  padding: 5px;
}

.pointer{
  cursor: pointer;
}

button:hover{
  cursor: pointer;
}

.disable {
  opacity : .35;
  background-color:lightgray;
}
</style>

<div id="content"></div>

<ul id="navigatorlist"></ul>

<div id="editor"></div>

<p id="current_furniture"></p>

<script type="text/javascript" src="modules.js"></script>
<script type="text/javascript" src="raphael-min-jt.js"></script>
<script type="text/javascript" src="roomedit.js"></script>
<script type="text/javascript">

  var three_spaces = ' \u00a0 '; // unicode &nbsp;

  var current_furniture = null;
  var current_furniture_doc = null;
  var all_furniture = [];

  var xmin;
  var ymin;
  var xscale;
  var yscale;
  var tooltip;
  var tooltip_bg;
  var paper;

  // convert URL parameters to dictionary

  var url = this.location;

  var paramdict = {};
  var params = url.href.split("?");

  if( 1 < params.length ) {
    url = params[0];
    paramdict = get_url_paramdict( params[1] );
  }

  var db = require('db').current();
  var $ = require('jquery');
  var furniture;

  if (paramdict.hasOwnProperty('furnitureid')){

    //======================================================
    // display and edit the selected element properties
    //======================================================

    var fid = paramdict['furnitureid'];
    db.getDoc( fid,
      function(err,resp) {
        if (err) {
          alert(JSON.stringify(err));
        }
        current_furniture_doc = resp;
        var rid = current_furniture_doc.roomId;
        var a = current_furniture_doc.properties;

        var p = $('<p/>').appendTo('#content');
        p.append( $('<a/>').text('Home').attr('href',url) );
        p.append( document.createTextNode( three_spaces ) );
        p.append( $('<a/>')
          .text('Back')
          .attr('href', url + '?roomid=' + rid ) );

        p = p.append($('<p/>').text(
          'Element properties of '
          + current_furniture_doc.name + ':' ));

        var keys = jt_get_keys( a );
        keys.sort();

        var table = p.append($('<table/>'));
        var n = keys.length;
        for( var i=0; i<n; ++i ) {
          var key = keys[i];
          var val = a[key];
          var key_label = capitalise(key);
          var key_id = unspace(key);
          var readonly = ('r' == val[0]);
          v = val.slice(2);
          table.append( '<tr><td>' + key_label
            + ':</td><td><input type="text" id="' + key_id
            + '" value="' + v + '"'
            + (readonly ? ' readonly class="disable"' : '')
            + '></td></tr>' );
        }
        table.append($('<br/>'));

        table.append($('<input/>')
          .attr( 'type', 'button')
          .attr( 'value', 'OK')
          .attr( 'onclick',
            'save_properties(current_furniture_doc,true)'));

        table.append( document
          .createTextNode( three_spaces ) );

        table.append($('<input/>')
          .attr( 'type', 'button')
          .attr( 'value', 'Cancel')
          .attr( 'onclick',
            'save_properties(current_furniture_doc,false)'));
      }
    );
  }
  else if (paramdict.hasOwnProperty('roomid')){

    //======================================================
    // display the selected room and its furniture
    //======================================================

    var rid = paramdict['roomid'];
    db.getDoc( rid,
      function(err,resp) {
        if (err) {
          alert(JSON.stringify(err));
        }
        var roomdoc = resp;
        var lid = roomdoc.levelId;
        db.getDoc( lid,
          function(err,resp) {
            if (err) {
              alert(JSON.stringify(err));
            }
            var leveldoc = resp;
            var mid = leveldoc.modelId;
            db.getDoc( mid,
              function(err,resp) {
                if (err) {
                  alert(JSON.stringify(err));
                }
                var modeldoc = resp;
                var q = { key: JSON.stringify(rid) };
                db.getView('roomedit', 'map_room_to_furniture', q,
                  function (err, data) {
                    if (err) {
                      alert(JSON.stringify(err));
                    }
                    var furniture=[];
                    var symbol_ids = [];
                    var n = data.rows.length;
                    for (var i = 0; i < n; ++i) {
                      var instdoc = data.rows[i].value;
                      var fid = instdoc._id;
                      console.log( 'doc id ' + fid + ' ' + instdoc.name );
                      if( instdoc.roomId != rid ) {
                        alert( 'room ids differ in furniture ' + instdoc._id
                          + ':\ndoc ' + instdoc.roomId + "\nurl " + rid );
                      }
                      var sid = instdoc.symbolId;
                      furniture.push(instdoc);
                      symbol_ids.push( sid );
                    }
                    var q2 = { keys: JSON.stringify(symbol_ids) };
                    db.getView('roomedit', 'symbols', q2,
                      function (err, data) {
                        if (err) {
                          alert(JSON.stringify(err));
                        }
                        var n2 = data.rows.length;
                        var map_symbid_to_loop = {};
                        for( var i = 0; i < n2; ++i ) {
                          var symbdoc = data.rows[i].value;
                          map_symbid_to_loop[symbdoc._id] = symbdoc.loop;
                        }
                        for( var i = 0; i < furniture.length; ++i ) {
                          furniture[i].loop = map_symbid_to_loop[furniture[i].symbolId];
                        }
                        var url_model = url + '?modelid=' + mid;
                        var url_level = url + '?levelid=' + lid;
                        var url_room = url + '?roomid=' + rid;

                        $('#content').append( $('<table/>')
                          .append( $('<tr>')
                            .append( $('<td>').text( 'Start:' ) )
                            .append( $('<td>')
                              .append( $('<a>')
                                .text('Home')
                                .attr('href',url) )))
                          .append( $('<tr>')
                            .append( $('<td>').text( 'Model:' ) )
                            .append( $('<td>')
                              .append( $('<a>')
                                .text(modeldoc.name)
                                .attr('href',url_model) )))
                          .append( $('<tr>')
                            .append( $('<td>').text( 'Level:' ) )
                            .append( $('<td>')
                              .append( $('<a>')
                                .text(leveldoc.name)
                                .attr('href',url_level) )))
                          .append( $('<tr>')
                            .append( $('<td>').text( 'Room:' ) )
                            .append( $('<td>')
                              .append( $('<a>')
                                .text(roomdoc.name)
                                .attr('href',url_room) ))))
                          .append($('<p/>')
                            .text( n.toString()
                              + ' furniture and equipment item' + pluralSuffix( n )
                              + ' in room ' )
                            .append( $('<i/>').text( roomdoc.name ) )
                            .append( document.createTextNode( ' on level ' ) )
                            .append( $('<i/>').text( leveldoc.name ) )
                            .append( document.createTextNode( ' in model ' ) )
                            .append( $('<i/>').text( modeldoc.name ) )
                            .append( document.createTextNode( '.' ) ) )
                          .append($('<p/>')
                            .text( 'Please pick and drag furniture '
                            + 'and equipment around to select and move it, '
                            + 'then click the buttons to rotate clockwise, '
                            + 'counter-clockwise, refresh, and save.' ));

                        var p = $('<p/>').appendTo('#content');

                        p.append( $('<button/>').text('Properties')
                          .attr('onclick', 'edit_properties_current(url)' ) );
                        p.append( document.createTextNode( three_spaces ) );
                        p.append( $('<button/>').text('Rotate')
                          .attr('onclick', 'rotate_current_cw()' ) );
                        p.append( document.createTextNode( three_spaces ) );
                        p.append( $('<button/>').text('Ccw')
                          .attr('onclick', 'rotate_current_ccw()' ) );
                        p.append( document.createTextNode( three_spaces ) );
                        p.append( $('<button/>').text('Refresh')
                          .attr('onclick', 'refresh()' ) );
                        p.append( document.createTextNode( three_spaces ) );
                        p.append( $('<button/>').text('Save')
                          .attr('id', 'save')
                          .attr('onclick', 'save_all()' ) );

                        raphael( roomdoc, furniture );
                      }
                    );
                  }
                );
              }
            );
          }
        );
      }
    );
  }
  else if( paramdict.hasOwnProperty( 'levelid' ) ) {

    //======================================================
    // display a menu of all rooms on selected level
    //======================================================

    var lid = paramdict['levelid'];
    db.getDoc( lid,
      function(err,resp) {
        if (err) {
          alert(JSON.stringify(err));
        }
        var leveldoc = resp;
        var mid = leveldoc.modelId;
        db.getDoc( mid,
          function(err,resp) {
            if (err) {
              alert(JSON.stringify(err));
            }
            var modeldoc = resp;
            db.getView('roomedit',
              'map_level_to_room',
              { key: JSON.stringify(lid) },

              function (err, data) {
                if (err) {
                  alert(JSON.stringify(err));
                }

                var url_model = url + '?modelid=' + mid;
                var url_level = url + '?levelid=' + lid;

                $('#content').append( $('<table/>')
                  .append( $('<tr>')
                    .append( $('<td>').text( 'Start:' ) )
                    .append( $('<td>')
                      .append( $('<a>')
                        .text('Home')
                        .attr('href',url) )))
                  .append( $('<tr>')
                    .append( $('<td>').text( 'Model:' ) )
                    .append( $('<td>')
                      .append( $('<a>')
                        .text(modeldoc.name)
                        .attr('href',url_model) )))
                  .append( $('<tr>')
                    .append( $('<td>').text( 'Level:' ) )
                    .append( $('<td>')
                      .append( $('<a>')
                        .text(leveldoc.name)
                        .attr('href',url_level) ))));

                var n = data.rows.length;

                var p = $('<p/>').text( n.toString()
                  + ' room' + pluralSuffix( n )
                  + ' on level ' ).appendTo('#content');
                p.append( $('<i/>').text( leveldoc.name ) );
                p.append( document.createTextNode( ' in model ' ) );
                p.append( $('<i/>').text( modeldoc.name ) );
                p.append( document.createTextNode( '.' ) );
                p.append( $('<p/>').text( 'Please select one:' ));

                for (var i = 0; i < n; ++i) {
                  var doc = data.rows[i].value;
                  if( doc.levelId != lid ) {
                    alert( 'model ids differ: doc ' + doc.levelId
                          + ", url " + lid );
                  }
                  var s = url + '?roomid=' + doc._id;
                  $('<li/>')
                    .append($('<a>')
                    .attr('href',s)
                    .text(doc.name))
                    .appendTo('#navigatorlist');
                }
              }
            );
          }
        );
      }
    );
  }
  else if ( paramdict.hasOwnProperty( 'modelid' ) ) {

    //===========================================================
    // display a menu of all levels and sheets in selected model
    //===========================================================

    var mid = paramdict['modelid'];
    db.getDoc( mid,
      function(err,resp) {
        if (err) {
          alert(JSON.stringify(err));
        }
        var modeldoc = resp;
        db.getView('roomedit',
          'map_model_to_level_and_sheet',
          { key: JSON.stringify(mid) },

          function (err, data) {
            if (err) {
              alert(JSON.stringify(err));
            }
            var url_model = url + '?modelid=' + mid;

            $('#content').append( $('<table/>')
              .append( $('<tr>')
                .append( $('<td>').text( 'Start:' ) )
                .append( $('<td>')
                  .append( $('<a>')
                    .text('Home')
                    .attr('href',url) )))
              .append( $('<tr>')
                .append( $('<td>').text( 'Model:' ) )
                .append( $('<td>')
                  .append( $('<a>')
                    .text(modeldoc.name)
                    .attr('href',url_model) ))));

            var n = data.rows.length;
            var nLevel = 0;
            var nSheet = 0;
            for (var i = 0; i < n; ++i) {
              var doc = data.rows[i].value;
              if( doc.modelId != mid ) {
                alert( 'model ids differ: doc '
                  + doc.modelId + ", url " + mid );
              }
              var t = doc.type; // level or sheet
              var s = url;

              if( 'level' == t ) {
                ++nLevel;
              }
              else {
                ++nSheet;
                s = s.replace( 'index.html', 'index2.html' );
              }

              s += '?' + t + 'id=' + doc._id;

              t = t.substr(0,1).toUpperCase() + t.substr(1);

              $('<li/>')
                .append(document.createTextNode(t + ': '))
                .append($('<a>').attr('href',s).text(doc.name))
                .appendTo('#navigatorlist');
            }
            var prompt =
              nLevel.toString() + ' level' + pluralSuffix( nLevel ) + ' and ' +
              nSheet.toString() + ' sheet' + pluralSuffix( nSheet ) + ' in model ';

            $('#content')
              .append($('<p/>')
                .text( prompt )
                .append( $('<i/>').text( modeldoc.name ) )
                .append( document.createTextNode( '.' ) ) )
              .append($('<p/>')
                .text( 'Please select a level or sheet:' ) );
          }
        );
      }
    );
  }
  else {

    //======================================================
    // display a menu of all available models
    //======================================================

    db.getView('roomedit', 'models',
      function (err, data) {
        if (err) {
          alert(JSON.stringify(err));
        }
        var n = data.rows.length;

        $('#content')
          .append($('<p/>')
            .text( n.toString() + ' model' + pluralSuffix( n )
              + ' available. Please select one:' ));

        var list = $('#navigatorlist');

        for (var i = 0; i < n; ++i) {
          var doc = data.rows[i].key;
          var s = url + '?modelid=' + doc._id;
          list.append($('<li/>')
            .append($('<a>').attr('href',s).text(doc.name)));
        }
      }
    );
  }
</script>
</body>
</html>
