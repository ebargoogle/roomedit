<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>

<h1>Room Editor</h1>

<style>
table{
  border-collapse: collapse;
}

table, th, td{
  border: 0px solid black;
  padding: 5px;
}

.pointer{
  cursor: pointer;
}

button:hover{
  cursor: pointer;
}
</style>

<div id="content"></div>

<ul id="navigatorlist"></ul>

<div id="editor"></div>

<p id="current_furniture"></p>

<script type="text/javascript" src="modules.js"></script>
<script type="text/javascript" src="raphael-min-jt.js"></script>
<script type="text/javascript" src="raphael.free_transform.js"></script>
<script type="text/javascript" src="roomedit.js"></script>
<script type="text/javascript">

  var three_spaces = ' \u00a0 '; // unicode &nbsp;

  var current_furniture = null;
  var all_furniture = [];

  var xmin;
  var ymin;
  var xscale;
  var yscale;
  var tooltip;
  var tooltip_bg;
  var paper;

  // convert URL parameters to dictionary

  var url = this.location;

  var paramdict = {};
  var params = url.href.split("?");

  if( 1 < params.length ) {
    url = params[0];
    paramdict = get_url_paramdict( params[1] );
  }

  // display main menu

  var db = require('db').current();
  var $ = require('jquery');
  var furniture;
  var symbol_count = 0;

  if (paramdict.hasOwnProperty('roomid')){

    //======================================================
    // display the selected room and its furniture
    //======================================================

    var rid = paramdict['roomid'];
    db.getDoc( rid,
      function(err,resp) {
        if (err) {
          return alert(JSON.stringify(err));
        }
        var roomdoc = resp;
        var lid = roomdoc.levelId;
        db.getDoc( lid,
          function(err,resp) {
            if (err) {
              return alert(JSON.stringify(err));
            }
            var leveldoc = resp;
            var mid = leveldoc.modelId;
            db.getDoc( mid,
              function(err,resp) {
                if (err) {
                  return alert(JSON.stringify(err));
                }
                var modeldoc = resp;
                var q = { key: JSON.stringify(rid) };
                db.getView('roomedit', 'map_room_to_furniture', q,
                  function (err, data) {
                    if (err) {
                      return alert(err);
                    }
                    var furniture=[];
                    var symbol_ids = [];
                    var n = data.rows.length;
                    for (var i = 0; i < n; ++i) {
                      var instdoc = data.rows[i].value;
                      var fid = instdoc._id;
                      console.log( 'doc id ' + fid + ' ' + instdoc.name );
                      if( instdoc.roomId != rid ) {
                        alert( 'room ids differ in furniture ' + instdoc._id
                          + ':\ndoc ' + instdoc.roomId + "\nurl " + rid );
                      }
                      var sid = instdoc.symbolId;
                      furniture.push(instdoc);
                      symbol_ids.push( sid );
                    }
                    var q2 = { keys: JSON.stringify(symbol_ids) };
                    db.getView('roomedit', 'symbols', q2,
                      function (err, data) {
                        if (err) {
                          return alert(err);
                        }
                        var n2 = data.rows.length;
                        var map_symbid_to_loop = {};
                        for( var i = 0; i < n2; ++i ) {
                          var symbdoc = data.rows[i].value;
                          map_symbid_to_loop[symbdoc._id] = symbdoc.loop;
                        }
                        for( var i = 0; i < furniture.length; ++i ) {
                          furniture[i].loop = map_symbid_to_loop[furniture[i].symbolId];
                        }
                        var p = $('<p/>').appendTo('#content');
                        p.append( $('<a/>').text('Refresh')
                                 .attr('href', url + '?roomid=' + rid ) );
                        p.append( document.createTextNode( three_spaces ) );
                        p.append( $('<a/>').text('Home').attr('href',url) );
                        p.append( document.createTextNode( three_spaces ) );
                        p.append( $('<a/>').text('Back')
                                 .attr('href', url + '?levelid=' + lid ) );

                        $('<p/>').text( 'Please pick and drag furniture '
                          + 'and equipment around to select and move it, '
                          + 'then click the buttons to rotate clockwise, '
                          + 'counter-clockwise, refresh, and save.' )
                          .appendTo('#content');

                        var table = $('<table/>').appendTo('#content');
                        table.append( '<tr><td>' + 'Model:'
                          + '</td><td>' + modeldoc.name + '</td></tr>' );
                        table.append( '<tr><td>' + 'Level:'
                          + '</td><td>' + leveldoc.name + '</td></tr>' );
                        table.append( '<tr><td>' + 'Room:'
                          + '</td><td>' + roomdoc.name + '</td></tr>' );

                        var p = $('<p/>').text( n.toString()
                          + ' furniture and equipment item' + pluralSuffix( n )
                          + ' in room ' ).appendTo('#content');
                        p.append( $('<i/>').text( roomdoc.name ) );
                        p.append( document.createTextNode( ' on level ' ) );
                        p.append( $('<i/>').text( leveldoc.name ) );
                        p.append( document.createTextNode( ' in model ' ) );
                        p.append( $('<i/>').text( modeldoc.name ) );
                        p.append( document.createTextNode( dotOrColon( n ) ) );

                        var p = $('<p/>').appendTo('#content');

                        p.append( $('<button/>').text('Rotate')
                          .attr('onclick', 'rotate_current_cw()' ) );
                        p.append( document.createTextNode( three_spaces ) );
                        p.append( $('<button/>').text('Ccw')
                          .attr('onclick', 'rotate_current_ccw()' ) );
                        p.append( document.createTextNode( three_spaces ) );
                        p.append( $('<button/>').text('Refresh')
                          .attr('onclick', 'refresh()' ) );
                        p.append( document.createTextNode( three_spaces ) );
                        p.append( $('<button/>').text('Save')
                          .attr('id', 'save')
                          .attr('onclick', 'save_all()' ) );

                        raphael( roomdoc, furniture );
                      }
                    );
                  }
                );
              }
            );
          }
        );
      }
    );
  }
  else if( paramdict.hasOwnProperty( 'levelid' ) ) {

    //======================================================
    // display a menu of all rooms on selected level
    //======================================================

    var lid = paramdict['levelid'];
    db.getDoc( lid,
      function(err,resp) {
        if (err) {
          return alert(JSON.stringify(err));
        }
        var leveldoc = resp;
        var mid = leveldoc.modelId;
        db.getDoc( mid,
          function(err,resp) {
            if (err) {
              return alert(JSON.stringify(err));
            }
            var modeldoc = resp;
            db.getView('roomedit',
              'map_level_to_room',
              { key: JSON.stringify(lid) },

              function (err, data) {
                if (err) {
                  return alert(err);
                }
                var n = data.rows.length;
                for (var i = 0; i < n; ++i) {
                  var doc = data.rows[i].value;
                  if( doc.levelId != lid ) {
                    alert( 'model ids differ: doc ' + doc.levelId
                          + ", url " + lid );
                  }
                  var s = url + '?roomid=' + doc._id;
                  $('<li/>')
                    .append($('<a>')
                    .attr('href',s)
                    .text(doc.name))
                    .appendTo('#navigatorlist');
                }
                var p = $('<p/>').appendTo('#content');
                p.append( $('<a/>').text('Home').attr('href',url) );
                p.append( document.createTextNode( three_spaces ) );
                p.append( $('<a/>')
                  .text('Back')
                  .attr('href', url + '?modelid=' + mid ) );

                $('<p/>')
                  .text( 'Please select a room in the list below.' )
                  .appendTo('#content');

                var table = $('<table/>').appendTo('#content');
                table.append( '<tr><td>' + 'Model:'
                  + '</td><td>' + modeldoc.name + '</td></tr>' );
                table.append( '<tr><td>' + 'Level:'
                  + '</td><td>' + leveldoc.name + '</td></tr>' );

                var p = $('<p/>').text( n.toString()
                  + ' room' + pluralSuffix( n )
                  + ' on level ' ).appendTo('#content');
                p.append( $('<i/>').text( leveldoc.name ) );
                p.append( document.createTextNode( ' in model ' ) );
                p.append( $('<i/>').text( modeldoc.name ) );
                p.append( document.createTextNode( dotOrColon( n ) ) );
              }
            );
          }
        );
      }
    );
  }
  else if ( paramdict.hasOwnProperty( 'modelid' ) ) {

    //===========================================================
    // display a menu of all levels and sheets in selected model
    //===========================================================

    var mid = paramdict['modelid'];
    db.getDoc( mid,
      function(err,resp) {
        if (err) {
          return alert(JSON.stringify(err));
        }
        var modeldoc = resp;
        db.getView('roomedit',
          'map_model_to_level_and_sheet',
          { key: JSON.stringify(mid) },

          function (err, data) {
            if (err) {
              return alert(err);
            }
            var n = data.rows.length;
            var nLevel = 0;
            var nSheet = 0;
            for (var i = 0; i < n; ++i) {
              var doc = data.rows[i].value;
              if( doc.modelId != mid ) {
                alert( 'model ids differ: doc '
                  + doc.modelId + ", url " + mid );
              }
              var t = doc.type; // level or sheet
              var s = url;

              if( 'level' == t ) {
                ++nLevel;
              }
              else {
                ++nSheet;
                s = s.replace( 'index.html', 'index2.html' );
              }

              s += '?' + t + 'id=' + doc._id;

              t = t.substr(0,1).toUpperCase() + t.substr(1);

              $('<li/>')
                .append(document.createTextNode(t + ': '))
                .append($('<a>').attr('href',s).text(doc.name))
                .appendTo('#navigatorlist');
            }
            var p = $('<p/>').appendTo('#content');
            p.append( $('<a/>').text('Home').attr('href',url) );
            p.append( document.createTextNode( three_spaces ) );
            p.append( $('<a/>').text('Back').attr('href',url) );

            $('<p/>')
              .text( 'Please select a level or sheet in the list below.' )
              .appendTo('#content');

            var table = $('<table/>').appendTo('#content');
            table.append( '<tr><td>' + 'Model:'
              + '</td><td>' + modeldoc.name + '</td></tr>' );

            var prompt =
              nLevel.toString() + ' level' + pluralSuffix( nLevel ) + ' and ' +
              nSheet.toString() + ' sheet' + pluralSuffix( nSheet ) + ' in model ';

            var p = $('<p/>').text( prompt ).appendTo('#content');
            p.append( $('<i/>').text( modeldoc.name ) );
            p.append( document.createTextNode( dotOrColon( n ) ) );
          }
        );
      }
    );
  }
  else {

    //======================================================
    // display a menu of all available models
    //======================================================

    db.getView('roomedit', 'models',
      function (err, data) {
        if (err) {
          return alert(err);
        }
        var n = data.rows.length;
        for (var i = 0; i < n; ++i) {
          var doc = data.rows[i].key;
          var s = url + '?modelid=' + doc._id;
          $('<li/>').append($('<a>')
            .attr('href',s)
            .text(doc.name))
          .appendTo('#navigatorlist');
        }
        var p = $('<p/>').appendTo('#content');
        p.append( $('<a/>').text('Home').attr('href',url) );
        p.append( document.createTextNode( three_spaces ) );
        p.append( $('<a/>').text('Back').attr('href',url) );

        $('<p/>')
          .text( 'Please select a model in the list below.' )
          .appendTo('#content');

        var prompt = n.toString() + ' model'
          + pluralSuffix( n ) + dotOrColon( n );

        $('<p/>').text( prompt ).appendTo('#content');
      }
    );
  }
</script>
</body>
</html>
